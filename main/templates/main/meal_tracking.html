{% extends 'base.html' %}

{% block title %}Meal Tracking - Claude Code{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Meal Tracking</h1>
        <p class="subtitle">Track your daily nutrition and meal planning</p>
        <div class="page-actions">
            <a href="{% url 'main:add_meal' %}" class="btn btn-primary">Add New Meal</a>
        </div>
    </div>
    
    <!-- Date Navigation Controls -->
    <div class="date-navigation">
        <div class="view-mode-toggle">
            <a href="?view=day&date={{ selected_date|date:'Y-m-d' }}" class="btn {% if view_mode == 'day' %}btn-primary{% else %}btn-outline{% endif %}">Daily View</a>
            <a href="?view=all" class="btn {% if view_mode == 'all' %}btn-primary{% else %}btn-outline{% endif %}">All Days</a>
        </div>
        
        {% if view_mode == 'day' %}
        <div class="daily-navigation">
            <div class="nav-controls">
                <a href="?view=day&date={{ prev_date|date:'Y-m-d' }}" class="btn btn-outline {% if not has_prev_meals %}disabled{% endif %}">
                    ← Previous Day
                </a>
                
                <div class="date-picker">
                    <input type="date" id="date-picker" value="{{ selected_date|date:'Y-m-d' }}" class="form-control">
                    <label for="date-picker">Jump to Date</label>
                </div>
                
                <a href="?view=day&date={{ next_date|date:'Y-m-d' }}" class="btn btn-outline {% if next_date > today and not has_next_meals %}disabled{% endif %}">
                    Next Day →
                </a>
            </div>
            
            <div class="today-button">
                <a href="?view=day" class="btn btn-success">Today</a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Content based on view mode -->
    {% if view_mode == 'day' %}
        <!-- Single Day View -->
        <div class="daily-nutrition-card">
            <div class="daily-header">
                <h2>{{ selected_date|date:"F j, Y" }}
                    {% if selected_date == today %}
                        <span class="today-badge">Today</span>
                    {% endif %}
                </h2>
                <div class="daily-totals">
                    <div class="nutrition-summary">
                        <div class="nutrition-item">
                            <span class="value">{{ daily_total.calories|floatformat:0 }}</span>
                            <span class="label">Calories</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="value">{{ daily_total.carbs|floatformat:1 }}g</span>
                            <span class="label">Carbs</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="value">{{ daily_total.fat|floatformat:1 }}g</span>
                            <span class="label">Fat</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="value">{{ daily_total.protein|floatformat:1 }}g</span>
                            <span class="label">Protein</span>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if daily_total.meals %}
                <div class="meals-list">
                    {% for meal in daily_total.meals %}
                    <div class="meal-card">
                        <div class="meal-header">
                            <h3><a href="{% url 'main:meal_detail' meal.id %}">{{ meal.name }}</a></h3>
                            <div class="meal-actions">
                                <a href="{% url 'main:edit_meal' meal.id %}" class="btn btn-sm btn-outline">Edit</a>
                                <a href="{% url 'main:delete_meal' meal.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this meal?')">Delete</a>
                            </div>
                        </div>
                        
                        <div class="meal-nutrition">
                            <span class="nutrition-value">{{ meal.total_calories|floatformat:0 }} cal</span>
                            <span class="nutrition-value">{{ meal.total_carbs|floatformat:1 }}g carbs</span>
                            <span class="nutrition-value">{{ meal.total_fat|floatformat:1 }}g fat</span>
                            <span class="nutrition-value">{{ meal.total_protein|floatformat:1 }}g protein</span>
                        </div>
                        
                        <div class="meal-foods">
                            <strong>Foods:</strong>
                            {% for food in meal.foods.all %}
                                <span class="food-item">{{ food.name }} ({{ food.grams }}g)</span>{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-meals-today">
                    <p>No meals tracked for this day.</p>
                    <a href="{% url 'main:add_meal' %}" class="btn btn-primary">Add Meal for {{ selected_date|date:"M j" }}</a>
                </div>
            {% endif %}
        </div>
    {% else %}
        <!-- All Days View -->
        {% if daily_totals %}
            {% for date, data in daily_totals.items %}
            <div class="daily-nutrition-card">
                <div class="daily-header">
                    <h2><a href="?view=day&date={{ date|date:'Y-m-d' }}">{{ date|date:"F j, Y" }}</a>
                        {% if date == today %}
                            <span class="today-badge">Today</span>
                        {% endif %}
                    </h2>
                    <div class="daily-totals">
                        <div class="nutrition-summary">
                            <div class="nutrition-item">
                                <span class="value">{{ data.calories|floatformat:0 }}</span>
                                <span class="label">Calories</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="value">{{ data.carbs|floatformat:1 }}g</span>
                                <span class="label">Carbs</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="value">{{ data.fat|floatformat:1 }}g</span>
                                <span class="label">Fat</span>
                            </div>
                            <div class="nutrition-item">
                                <span class="value">{{ data.protein|floatformat:1 }}g</span>
                                <span class="label">Protein</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="meals-list">
                    {% for meal in data.meals %}
                    <div class="meal-card">
                        <div class="meal-header">
                            <h3><a href="{% url 'main:meal_detail' meal.id %}">{{ meal.name }}</a></h3>
                            <div class="meal-actions">
                                <a href="{% url 'main:edit_meal' meal.id %}" class="btn btn-sm btn-outline">Edit</a>
                                <a href="{% url 'main:delete_meal' meal.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this meal?')">Delete</a>
                            </div>
                        </div>
                        
                        <div class="meal-nutrition">
                            <span class="nutrition-value">{{ meal.total_calories|floatformat:0 }} cal</span>
                            <span class="nutrition-value">{{ meal.total_carbs|floatformat:1 }}g carbs</span>
                            <span class="nutrition-value">{{ meal.total_fat|floatformat:1 }}g fat</span>
                            <span class="nutrition-value">{{ meal.total_protein|floatformat:1 }}g protein</span>
                        </div>
                        
                        <div class="meal-foods">
                            <strong>Foods:</strong>
                            {% for food in meal.foods.all %}
                                <span class="food-item">{{ food.name }} ({{ food.grams }}g)</span>{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <h3>No Meals Tracked Yet</h3>
                <p>Start tracking your nutrition by adding your first meal!</p>
                <a href="{% url 'main:add_meal' %}" class="btn btn-primary">Add Your First Meal</a>
            </div>
        {% endif %}
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const datePicker = document.getElementById('date-picker');
    if (datePicker) {
        datePicker.addEventListener('change', function() {
            const selectedDate = this.value;
            if (selectedDate) {
                window.location.href = `?view=day&date=${selectedDate}`;
            }
        });
    }
});
</script>

<style>
.date-navigation {
    background: #f8f9fa;
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 24px;
    border: 1px solid #e0e0e0;
}

.view-mode-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.daily-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-controls {
    display: flex;
    align-items: center;
    gap: 16px;
}

.date-picker {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.date-picker input {
    width: 160px;
}

.date-picker label {
    font-size: 12px;
    color: #666;
    text-align: center;
}

.today-badge {
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    margin-left: 8px;
}

.no-meals-today {
    text-align: center;
    padding: 40px 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin: 20px;
}

.disabled {
    pointer-events: none;
    opacity: 0.5;
}

.daily-nutrition-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 24px;
    overflow: hidden;
    background: white;
}

.daily-header {
    background: #f8f9fa;
    padding: 16px 20px;
    border-bottom: 1px solid #e0e0e0;
}

.daily-header h2 {
    margin: 0 0 12px 0;
    color: #333;
}

.nutrition-summary {
    display: flex;
    gap: 24px;
}

.nutrition-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.nutrition-item .value {
    font-size: 20px;
    font-weight: bold;
    color: #007bff;
}

.nutrition-item .label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
}

.meals-list {
    padding: 20px;
}

.meal-card {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 16px;
}

.meal-card:last-child {
    margin-bottom: 0;
}

.meal-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 12px;
}

.meal-header h3 {
    margin: 0;
}

.meal-header h3 a {
    color: #333;
    text-decoration: none;
}

.meal-header h3 a:hover {
    color: #007bff;
}

.meal-actions {
    display: flex;
    gap: 8px;
}

.meal-nutrition {
    display: flex;
    gap: 16px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.nutrition-value {
    background: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 14px;
    border: 1px solid #e0e0e0;
}

.meal-foods {
    font-size: 14px;
    color: #666;
}

.food-item {
    color: #333;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

@media (max-width: 768px) {
    .daily-header {
        padding: 12px 16px;
    }
    
    .nutrition-summary {
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .meal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .meal-nutrition {
        flex-direction: column;
        gap: 8px;
    }
}
</style>
{% endblock %}