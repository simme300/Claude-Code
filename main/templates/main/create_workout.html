{% extends 'base.html' %}

{% block title %}Create Workout - Claude Code{% endblock %}

{% block content %}
<div class="container">
    <h2>Create New Workout</h2>
    
    <form method="post" class="workout-form">
        {% csrf_token %}
        
        <div class="form-layout">
            <div class="workout-details">
                <h3>Workout Details</h3>
            
            <div class="form-group">
                <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
                {{ form.title }}
                {% if form.title.errors %}
                    <div class="error-messages">
                        {% for error in form.title.errors %}
                            <span class="error">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.day.id_for_label }}">{{ form.day.label }}</label>
                {{ form.day }}
                {% if form.day.errors %}
                    <div class="error-messages">
                        {% for error in form.day.errors %}
                            <span class="error">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.duration.id_for_label }}">{{ form.duration.label }}</label>
                {{ form.duration }}
                <small class="form-text">Format: HH:MM:SS (e.g., 01:30:00 for 1 hour 30 minutes)</small>
                {% if form.duration.errors %}
                    <div class="error-messages">
                        {% for error in form.duration.errors %}
                            <span class="error">{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
                </div>
            </div>
        
            <div class="exercises-section">
            <h3>Exercises</h3>
            <p class="section-description">Add exercises to your workout. Click "Add Exercise" to add more exercises as needed.</p>
            
            {% if exercise_error %}
                <div class="error-messages">
                    <span class="error">{{ exercise_error }}</span>
                </div>
            {% endif %}
            
            {{ exercise_formset.management_form }}
            
            <div class="exercise-formset" id="exercise-formset">
                {% for exercise_form in exercise_formset %}
                    <div class="exercise-form" data-form-index="{{ forloop.counter0 }}">
                        <div class="exercise-header">
                            <h4>Exercise {{ forloop.counter }}</h4>
                            {% if not forloop.first %}
                                <button type="button" class="btn-remove-exercise" onclick="removeExercise(this)">Remove</button>
                            {% endif %}
                        </div>
                        
                        <div class="exercise-fields">
                            <div class="form-group">
                                <label for="{{ exercise_form.name.id_for_label }}">Exercise Name</label>
                                {{ exercise_form.name }}
                                {% if exercise_form.name.errors %}
                                    <div class="error-messages">
                                        {% for error in exercise_form.name.errors %}
                                            <span class="error">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="sets-section">
                                <h5>Sets</h5>
                                <p class="sets-description">Add sets for this exercise. You can add different reps and weights for each set.</p>
                                
                                <div class="sets-container" data-exercise-index="{{ forloop.counter0 }}">
                                    <div class="set-form" data-set-index="0">
                                        <div class="set-header">
                                            <span class="set-number">Set 1</span>
                                            <button type="button" class="btn-remove-set" onclick="removeSet(this)" style="display: none;">Remove</button>
                                        </div>
                                        <div class="set-fields">
                                            <div class="form-group">
                                                <label>Reps</label>
                                                <input type="number" name="exercise_{{ forloop.counter0 }}_set_0_reps" class="form-control" min="0" placeholder="12">
                                            </div>
                                            <div class="form-group">
                                                <label>Weight</label>
                                                <input type="number" name="exercise_{{ forloop.counter0 }}_set_0_weight" class="form-control" min="0" step="0.01" placeholder="50">
                                            </div>
                                            <div class="form-group">
                                                <label>Unit</label>
                                                <select name="exercise_{{ forloop.counter0 }}_set_0_weight_unit" class="form-control">
                                                    <option value="Lbs">Lbs</option>
                                                    <option value="Kg">Kg</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="add-set-section">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="addSet({{ forloop.counter0 }})">Add Set</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
                <div class="add-exercise-section">
                    <button type="button" class="btn btn-secondary" onclick="addExercise()">Add Exercise</button>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Create Workout</button>
            <a href="{% url 'main:homepage' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// Exercise form management functions
function addExercise() {
    const formset = document.getElementById('exercise-formset');
    const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
    
    if (!formset || !totalFormsInput) {
        console.error('Required elements not found');
        return;
    }
    
    const currentFormCount = parseInt(totalFormsInput.value);
    
    // Clone the first exercise form
    const firstForm = formset.querySelector('.exercise-form');
    if (!firstForm) {
        console.error('No exercise form found to clone');
        return;
    }
    
    const newForm = firstForm.cloneNode(true);
    
    // Update form index
    newForm.setAttribute('data-form-index', currentFormCount);
    
    // Clear all input values in the new form
    const inputs = newForm.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.type === 'text' || input.type === 'number') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        }
        
        // Update input names and IDs for the new form
        const name = input.getAttribute('name');
        const id = input.getAttribute('id');
        if (name) {
            const newName = name.replace(/form-\d+/, `form-${currentFormCount}`);
            input.setAttribute('name', newName);
        }
        if (id) {
            const newId = id.replace(/form-\d+/, `form-${currentFormCount}`);
            input.setAttribute('id', newId);
        }
    });
    
    // Update set form names for the new exercise
    const setInputs = newForm.querySelectorAll('.sets-container input, .sets-container select');
    setInputs.forEach(input => {
        const name = input.getAttribute('name');
        if (name) {
            const newName = name.replace(/exercise_\d+/, `exercise_${currentFormCount}`);
            input.setAttribute('name', newName);
        }
    });
    
    // Update sets container data attribute
    const setsContainer = newForm.querySelector('.sets-container');
    if (setsContainer) {
        setsContainer.setAttribute('data-exercise-index', currentFormCount);
    }
    
    // Reset sets to just one set
    const setsContainer2 = newForm.querySelector('.sets-container');
    const setForms = setsContainer2.querySelectorAll('.set-form');
    setForms.forEach((setForm, index) => {
        if (index > 0) {
            setForm.remove();
        }
    });
    
    // Update labels for attributes
    const labels = newForm.querySelectorAll('label');
    labels.forEach(label => {
        const forAttr = label.getAttribute('for');
        if (forAttr) {
            const newFor = forAttr.replace(/form-\d+/, `form-${currentFormCount}`);
            label.setAttribute('for', newFor);
        }
    });
    
    // Clear error messages
    const errorDivs = newForm.querySelectorAll('.error-messages');
    errorDivs.forEach(div => div.remove());
    
    // Ensure remove button exists
    const header = newForm.querySelector('.exercise-header');
    let removeBtn = header.querySelector('.btn-remove-exercise');
    if (!removeBtn) {
        removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-remove-exercise';
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = function() { removeExercise(this); };
        header.appendChild(removeBtn);
    }
    
    // Append the new form
    formset.appendChild(newForm);
    
    // Update total forms count
    totalFormsInput.value = currentFormCount + 1;
    
    // Update exercise numbers
    updateExerciseNumbers();
}

function removeExercise(button) {
    const exerciseForm = button.closest('.exercise-form');
    const formset = document.getElementById('exercise-formset');
    
    // Don't remove if it's the only form
    if (formset.querySelectorAll('.exercise-form').length <= 1) {
        return;
    }
    
    exerciseForm.remove();
    
    // Update total forms count
    const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
    totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
    
    // Update exercise numbers
    updateExerciseNumbers();
    
    // Re-index all forms
    reindexForms();
}

function addSet(exerciseIndex) {
    const setsContainer = document.querySelector(`[data-exercise-index="${exerciseIndex}"]`);
    if (!setsContainer) return;
    
    const setForms = setsContainer.querySelectorAll('.set-form');
    const setIndex = setForms.length;
    
    // Clone the first set form
    const firstSet = setForms[0];
    const newSet = firstSet.cloneNode(true);
    
    // Update set index
    newSet.setAttribute('data-set-index', setIndex);
    
    // Clear values
    const inputs = newSet.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.type === 'number') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        }
        
        // Update input names
        const name = input.getAttribute('name');
        if (name) {
            const newName = name.replace(/_set_\d+_/, `_set_${setIndex}_`);
            input.setAttribute('name', newName);
        }
    });
    
    // Update set number
    const setNumber = newSet.querySelector('.set-number');
    setNumber.textContent = `Set ${setIndex + 1}`;
    
    // Show remove button
    const removeBtn = newSet.querySelector('.btn-remove-set');
    removeBtn.style.display = 'inline-block';
    
    setsContainer.appendChild(newSet);
    updateSetRemoveButtons(setsContainer);
}

function removeSet(button) {
    const setForm = button.closest('.set-form');
    const setsContainer = setForm.closest('.sets-container');
    
    // Don't remove if it's the only set
    if (setsContainer.querySelectorAll('.set-form').length <= 1) {
        return;
    }
    
    setForm.remove();
    updateSetNumbers(setsContainer);
    updateSetRemoveButtons(setsContainer);
}

function updateSetNumbers(setsContainer) {
    const setForms = setsContainer.querySelectorAll('.set-form');
    setForms.forEach((setForm, index) => {
        const setNumber = setForm.querySelector('.set-number');
        setNumber.textContent = `Set ${index + 1}`;
        setForm.setAttribute('data-set-index', index);
        
        // Update input names
        const inputs = setForm.querySelectorAll('input, select');
        inputs.forEach(input => {
            const name = input.getAttribute('name');
            if (name) {
                const newName = name.replace(/_set_\d+_/, `_set_${index}_`);
                input.setAttribute('name', newName);
            }
        });
    });
}

function updateSetRemoveButtons(setsContainer) {
    const setForms = setsContainer.querySelectorAll('.set-form');
    setForms.forEach((setForm, index) => {
        const removeBtn = setForm.querySelector('.btn-remove-set');
        if (index === 0 && setForms.length === 1) {
            removeBtn.style.display = 'none';
        } else {
            removeBtn.style.display = 'inline-block';
        }
    });
}

function updateExerciseNumbers() {
    const exerciseForms = document.querySelectorAll('.exercise-form');
    exerciseForms.forEach((form, index) => {
        const header = form.querySelector('h4');
        if (header) {
            header.textContent = `Exercise ${index + 1}`;
        }
    });
}

function reindexForms() {
    const exerciseForms = document.querySelectorAll('.exercise-form');
    exerciseForms.forEach((form, index) => {
        form.setAttribute('data-form-index', index);
        
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            const name = input.getAttribute('name');
            const id = input.getAttribute('id');
            if (name) {
                if (name.startsWith('exercise_')) {
                    // Handle set inputs
                    const newName = name.replace(/exercise_\d+/, `exercise_${index}`);
                    input.setAttribute('name', newName);
                } else {
                    // Handle exercise form inputs
                    input.setAttribute('name', name.replace(/form-\d+/, `form-${index}`));
                }
            }
            if (id) {
                input.setAttribute('id', id.replace(/form-\d+/, `form-${index}`));
            }
        });
        
        const labels = form.querySelectorAll('label');
        labels.forEach(label => {
            const forAttr = label.getAttribute('for');
            if (forAttr) {
                label.setAttribute('for', forAttr.replace(/form-\d+/, `form-${index}`));
            }
        });
        
        // Update sets container
        const setsContainer = form.querySelector('.sets-container');
        if (setsContainer) {
            setsContainer.setAttribute('data-exercise-index', index);
        }
    });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    updateExerciseNumbers();
    
    // Initialize set remove buttons
    document.querySelectorAll('.sets-container').forEach(container => {
        updateSetRemoveButtons(container);
    });
});
</script>

<style>
.form-layout {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.workout-details {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    height: fit-content;
}

.exercises-section {
    background: #ffffff;
    padding: 1.5rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.workout-details h3,
.exercises-section h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #495057;
    font-size: 1.25rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group:last-child {
    margin-bottom: 0;
}

/* Compact exercises section styling */
.exercises-section .section-description {
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.exercise-form {
    margin-bottom: 0.75rem;
    padding: 0.5rem;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    background: #f8f9fa;
}

.exercise-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.4rem;
}

.exercise-header h4 {
    margin: 0;
    font-size: 0.95rem;
    color: #495057;
}

.exercise-fields .form-group {
    margin-bottom: 0.5rem;
}

.sets-section h5 {
    margin: 0.5rem 0 0.3rem 0;
    font-size: 0.85rem;
    color: #6c757d;
}

.sets-description {
    margin-bottom: 0.3rem;
    font-size: 0.8rem;
    color: #6c757d;
}

.set-form {
    margin-bottom: 0.4rem;
    padding: 0.4rem;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    background: white;
}

.set-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.3rem;
}

.set-number {
    font-weight: 500;
    font-size: 0.8rem;
    color: #495057;
}

.set-fields {
    display: grid;
    grid-template-columns: 1fr 1fr 70px;
    gap: 0.4rem;
}

.set-fields .form-group {
    margin-bottom: 0;
}

.set-fields label {
    font-size: 0.75rem;
    margin-bottom: 0.2rem;
    display: block;
}

.set-fields input,
.set-fields select {
    padding: 0.3rem;
    font-size: 0.85rem;
}

.add-set-section {
    margin-top: 0.4rem;
}

.add-exercise-section {
    margin-top: 0.75rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.btn-remove-exercise,
.btn-remove-set {
    padding: 0.2rem 0.5rem;
    font-size: 0.75rem;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

.btn-remove-exercise:hover,
.btn-remove-set:hover {
    background-color: #c82333;
}

/* Form actions styling */
.form-actions {
    margin-top: 2rem;
    display: flex;
    gap: 1rem;
    align-items: center;
}

.form-actions .btn {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    border-radius: 6px;
    text-decoration: none;
    display: inline-block;
    font-weight: 500;
    transition: all 0.2s ease;
}

.form-actions .btn-primary {
    background-color: #007bff;
    color: white;
    border: none;
}

.form-actions .btn-primary:hover {
    background-color: #0056b3;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

.form-actions .btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
}

.form-actions .btn-secondary:hover {
    background-color: #545b62;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
}

/* Responsive design for smaller screens */
@media (max-width: 768px) {
    .form-layout {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .workout-details,
    .exercises-section {
        padding: 1rem;
    }
    
    .set-fields {
        grid-template-columns: 1fr;
        gap: 0.25rem;
    }
    
    .exercise-form {
        padding: 0.5rem;
    }
    
    .form-actions {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
    }
    
    .form-actions .btn {
        width: 100%;
        text-align: center;
    }
}

@media (max-width: 992px) {
    .form-layout {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .set-fields {
        grid-template-columns: 1fr 1fr 60px;
        gap: 0.25rem;
    }
}
</style>
{% endblock %}